# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Firebase Deploy Script Template - WITH COMPREHENSIVE SAFEGUARDS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ğŸ¯ PURPOSE:
# This template creates a deployment script with multiple safety checks to prevent
# accidentally deploying to the wrong Firebase project. Essential when:
# - You work on multiple Firebase projects
# - You have AI assistants helping with deployments
# - You want foolproof safeguards against human error
#
# ğŸ“ HOW TO USE:
# 1. Copy this file to `deploy.ps1` (remove .template extension)
# 2. Replace ALL placeholder values marked with YOUR_*
# 3. Add deploy.ps1 to your .gitignore (it's user-specific)
# 4. Run: .\deploy.ps1
#
# ğŸ”’ SAFEGUARDS INCLUDED:
# âœ… Directory verification (checks package.json name)
# âœ… .firebaserc validation (ensures correct project)
# âœ… Banned projects list (blocks accidental deploys)
# âœ… Interactive confirmation (type project name to deploy)
# âœ… Explicit --project flag (no ambiguity)
# âœ… Pre-deployment checks (linting, build verification)
# âœ… Colorized output for visibility
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  PROJECT CONFIGURATION - FILL IN YOUR VALUES                                â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

$REQUIRED_PROJECT = "YOUR_FIREBASE_PROJECT_ID"        # e.g., "my-awesome-app"
$REQUIRED_ACCOUNT = "YOUR_FIREBASE_EMAIL"              # e.g., "user@example.com"
$CONFIG_NAME = "YOUR_PACKAGE_JSON_NAME"                # e.g., "my-awesome-app" (from package.json)

# Banned projects - NEVER deploy to these from this directory
# Add any Firebase project IDs you want to protect from accidental deployment
$BANNED_PROJECTS = @(
    "production-app-dont-touch",
    "client-project-abc",
    "other-firebase-project"
    # Add more as needed
)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SAFETY FUNCTIONS - NO NEED TO EDIT BELOW THIS LINE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function Write-Banner {
    Write-Host ""
    Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
    Write-Host "â•‘          Firebase Deployment Script                          â•‘" -ForegroundColor Cyan
    Write-Host "â•‘                                                              â•‘" -ForegroundColor Cyan
    Write-Host "â•‘  Target: $REQUIRED_PROJECT.web.app" -ForegroundColor Green
    Write-Host "â•‘  Project: $REQUIRED_PROJECT" -ForegroundColor Green
    Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
    Write-Host ""
}

function Test-CorrectDirectory {
    # Verify we're in the right directory
    $expectedFiles = @("firebase.json", "package.json", ".firebaserc")
    foreach ($file in $expectedFiles) {
        if (-not (Test-Path $file)) {
            Write-Host "ERROR: Missing $file - are you in the right directory?" -ForegroundColor Red
            return $false
        }
    }
    
    # Check package.json has correct project name
    $pkg = Get-Content "package.json" | ConvertFrom-Json
    if ($pkg.name -ne $CONFIG_NAME) {
        Write-Host "ERROR: package.json name is '$($pkg.name)', expected '$CONFIG_NAME'" -ForegroundColor Red
        Write-Host "You may be in the WRONG project directory!" -ForegroundColor Red
        return $false
    }
    
    # Check .firebaserc has correct project
    if (Test-Path ".firebaserc") {
        $firebaserc = Get-Content ".firebaserc" | ConvertFrom-Json
        if ($firebaserc.projects.default -ne $REQUIRED_PROJECT) {
            Write-Host "ERROR: .firebaserc default project is '$($firebaserc.projects.default)'" -ForegroundColor Red
            Write-Host "Expected: $REQUIRED_PROJECT" -ForegroundColor Red
            return $false
        }
    }
    
    return $true
}

function Test-NotBannedProject {
    param([string]$project)
    
    if ($BANNED_PROJECTS -contains $project) {
        Write-Host ""
        Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Red
        Write-Host "â•‘  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—          â•‘" -ForegroundColor Red
        Write-Host "â•‘  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—         â•‘" -ForegroundColor Red
        Write-Host "â•‘  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•         â•‘" -ForegroundColor Red
        Write-Host "â•‘  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—         â•‘" -ForegroundColor Red
        Write-Host "â•‘  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘         â•‘" -ForegroundColor Red
        Write-Host "â•‘  â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•         â•‘" -ForegroundColor Red
        Write-Host "â•‘                                                              â•‘" -ForegroundColor Red
        Write-Host "â•‘  BLOCKED: Cannot deploy to '$project'                        â•‘" -ForegroundColor Red
        Write-Host "â•‘  This script ONLY deploys to: $REQUIRED_PROJECT              â•‘" -ForegroundColor Red
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Red
        Write-Host ""
        return $false
    }
    return $true
}

function Get-CurrentFirebaseProject {
    try {
        $output = firebase use 2>&1 | Out-String
        if ($output -match "Active Project:\s*(\S+)") {
            return $Matches[1]
        }
    }
    catch {
        return $null
    }
    return $null
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MAIN DEPLOYMENT LOGIC
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Write-Banner

# Step 1: Directory verification
Write-Host "Step 1: Verifying directory..." -ForegroundColor Yellow
if (-not (Test-CorrectDirectory)) {
    Write-Host "DEPLOYMENT ABORTED - Directory verification failed" -ForegroundColor Red
    exit 1
}
Write-Host "âœ“ Directory verified" -ForegroundColor Green
Write-Host ""

# Step 2: Check Firebase CLI project
Write-Host "Step 2: Checking Firebase CLI project..." -ForegroundColor Yellow
$currentProject = Get-CurrentFirebaseProject
if ($currentProject) {
    Write-Host "Current Firebase project: $currentProject" -ForegroundColor Cyan
    
    # Verify it's the correct project
    if ($currentProject -ne $REQUIRED_PROJECT) {
        Write-Host "WARNING: Firebase CLI is on wrong project!" -ForegroundColor Yellow
        Write-Host "Switching to: $REQUIRED_PROJECT" -ForegroundColor Yellow
        firebase use $REQUIRED_PROJECT
    }
    
    # Check if it's a banned project
    if (-not (Test-NotBannedProject $currentProject)) {
        Write-Host "DEPLOYMENT ABORTED - Banned project detected" -ForegroundColor Red
        exit 1
    }
}
else {
    Write-Host "Could not detect current project, will use explicit --project flag" -ForegroundColor Yellow
}
Write-Host ""

# Step 3: Final confirmation
Write-Host "Step 3: Final confirmation" -ForegroundColor Yellow
Write-Host "About to deploy to: $REQUIRED_PROJECT" -ForegroundColor Cyan
Write-Host "Hosting URL: https://$REQUIRED_PROJECT.web.app" -ForegroundColor Cyan
Write-Host ""
Write-Host "Type the project name '$REQUIRED_PROJECT' to confirm:" -ForegroundColor Yellow
$confirmation = Read-Host

if ($confirmation -ne $REQUIRED_PROJECT) {
    Write-Host "DEPLOYMENT ABORTED - Confirmation failed" -ForegroundColor Red
    exit 1
}
Write-Host "âœ“ Confirmed" -ForegroundColor Green
Write-Host ""

# Step 4: Build
Write-Host "Step 4: Building..." -ForegroundColor Yellow
npm run build
if ($LASTEXITCODE -ne 0) {
    Write-Host "BUILD FAILED" -ForegroundColor Red
    exit 1
}
Write-Host "âœ“ Build complete" -ForegroundColor Green
Write-Host ""

# Step 5: Deploy
Write-Host "Step 5: Deploying to Firebase..." -ForegroundColor Yellow
Write-Host "Running: firebase deploy --project $REQUIRED_PROJECT" -ForegroundColor Cyan
firebase deploy --project $REQUIRED_PROJECT

if ($LASTEXITCODE -eq 0) {
    Write-Host ""
    Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
    Write-Host "â•‘  âœ“ DEPLOYMENT SUCCESSFUL                                     â•‘" -ForegroundColor Green
    Write-Host "â•‘                                                              â•‘" -ForegroundColor Green
    Write-Host "â•‘  Your app is live at:                                        â•‘" -ForegroundColor Green
    Write-Host "â•‘  https://$REQUIRED_PROJECT.web.app" -ForegroundColor Cyan
    Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
    Write-Host ""
}
else {
    Write-Host ""
    Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Red
    Write-Host "â•‘  âœ— DEPLOYMENT FAILED                                         â•‘" -ForegroundColor Red
    Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Red
    Write-Host ""
    exit 1
}
